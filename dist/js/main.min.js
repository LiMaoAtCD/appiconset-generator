"use strict";const i18n=require("i18next"),i18nextBackend=require("i18next-sync-fs-backend"),LanguageDetector=require("i18next-electron-language-detector"),path=require("path"),i18nextOptions={fallbackLng:"en",debug:!1,ns:["app","menu","prefs","about"],defaultNS:"app",backend:{loadPath:path.join(__dirname,"../i18n/{{lng}}/{{ns}}.json"),addPath:path.join(__dirname,"../i18n/{{lng}}/{{ns}}.missing.json"),jsonIndent:2},saveMissing:!0,initImmediate:!0};i18n.use(LanguageDetector).use(i18nextBackend),i18n.init(i18nextOptions);const{app:app,BrowserWindow:BrowserWindow,TouchBar:TouchBar,ipcMain:ipcMain}=require("electron"),{TouchBarButton:TouchBarButton,TouchBarSpacer:TouchBarSpacer,TouchBarSegmentedControl:TouchBarSegmentedControl}=TouchBar,url=require("url"),fs=require("fs-extra"),sharp=require("electron-sharp"),dialog=require("electron").dialog,Store=require("electron-store"),util=require("util"),loadJSON=require("load-json-file");let win,modal,tempString,touchBar1,touchBar2,prefsTouchBar,group,groupPrefs,appIdentifier="com.midwinter-dg."+app.getName().toLowerCase().replace(" ","-"),tempDir=app.getPath("temp")+`${appIdentifier}/`,buttons=[],generate=[],prefsButtons=[],store=new Store({defaults:{windowBounds:{x:0,y:0},iconType:0,interpolation:"lanczos3",savePath:app.getPath("desktop")}});function createWindow(){let{x:e,y:t,width:n,height:o}=store.get("windowBounds");function a(){store.set("windowBounds",win.getBounds())}(win=new BrowserWindow({show:!1,titleBarStyle:"hidden",x:e,y:t,width:820,height:620,transparent:!0,resizable:!1,maximizable:!1,fullscreen:!1,webPreferences:{preload:path.join(__dirname,"./preload.min.js")},icon:path.join(__dirname,"../assets/icon/Icon.icns")})).setSheetOffset(23),win.loadURL(url.format({pathname:path.join(__dirname,"../html/app.html"),protocol:"file:",slashes:!0})),win.once("ready-to-show",()=>{win.show(),empty()}),win.on("resize",a),win.on("move",a),win.on("closed",()=>{app.quit(),empty()}),require("./menu-app.min")}function empty(){fs.emptyDir(tempDir,e=>{if(e)return console.error(e)})}function saveIconsetToPath(e){let t=store.get("savePath");dialog.showSaveDialog(win,{defaultPath:t+"/AppIcon.appiconset",buttonLabel:"Save Appiconset"},function(t){t&&fs.copy(e,t,e=>{if(e)return console.error(e);console.info("success!")})})}app.on("ready",createWindow),app.on("open",e=>{dialog.showOpenDialog(win,{defaultPath:app.getPath("home"),buttonLabel:i18n.t("app:dialog.open.button","Choose Image"),filters:[{name:"Images",extensions:["png","jpg","gif","bmp"]}],properties:["openFile"],message:i18n.t("app:dialog.open.message","The file must be one of the following types: .png, .jpg, .gif, .bmp")},function(e){e&&win.webContents.send("load",e)})}),ipcMain.on("touchbar",(e,t)=>{let n,o=[],a=0,i=0;for(let e of t)o.push({label:e.type}),e.state&&(i=a),a++;n=new TouchBarSpacer({size:"small"}),group=new TouchBarSegmentedControl({segmentStyle:"separated",mode:"single",segments:o,selectedIndex:i,change:e=>{win.webContents.send("touchbar-select",e)}}),buttons.push(group),generate.push(group),buttons.push(n),generate.push(n),generate.push(new TouchBarButton({label:i18n.t("app:button.generate","Generate Appiconset"),backgroundColor:"#3B88FD",click:()=>{win.webContents.send("menu-generate","generate")}})),touchBar1=new TouchBar(buttons),win.setTouchBar(touchBar1)}),ipcMain.on("touchbar-index",(e,t)=>{group.selectedIndex=t}),ipcMain.on("size",(e,t)=>{dialog.showMessageBox(win,{type:"info",message:i18n.t("app:dialog.size.message","Image too small"),detail:i18n.t("app:dialog.size.detail","For best results the image must be at least\n1024 x 1024px"),buttons:["OK"]})}),ipcMain.on("valid",(e,t)=>{let n=t.replace(/^data:image\/\w+;base64,/,""),o=Buffer.from(n,"base64");tempString=Date.now(),fs.ensureDir(`${tempDir}/${tempString}/`,e=>{if(e)return console.error(e);fs.writeFile(`${tempDir}/${tempString}.png`,o,function(e){if(e)return console.error(e);win.webContents.send("preview",`${tempDir}/${tempString}.png`),touchBar2=new TouchBar(generate),win.setTouchBar(touchBar2)})})}),ipcMain.on("invalid",(e,t)=>{dialog.showMessageBox(win,{type:"error",message:i18n.t("app:dialog.error.message","Invalid file format"),detail:i18n.t("app:dialog.error.detail","{{message}} is not a valid image file.\nThe file must be one of the following types: .png, .jpg, .gif, .bmp"),buttons:[i18n.t("app:dialog.error.ok","OK")]})}),ipcMain.on("generate",(e,t)=>{fs.emptyDirSync(`${tempDir}/${tempString}/`);let n=store.get("interpolation"),o=sharp(`${tempDir}/${tempString}.png`),a={images:[],info:{version:1,author:appIdentifier}};loadJSON(path.join(__dirname,"../json/iconsets.json")).then(e=>{let i=[];for(let r of e[t]){let e=r.size*r.scale,t=`icon_${r.size}x${r.size}@${r.scale}x.png`;!1===i.includes(t)&&(i.push(t),o.resize(e,e,{kernel:sharp.kernel[n],fit:"contain",position:"left top"}).toFile(`${tempDir}/${tempString}/${t}`).then(()=>{console.info(`generated ${r.size} - @${r.scale}x`)}),a.images.push({size:`${r.size}x${r.size}`,idiom:r.idiom,filename:t,scale:`${r.scale}x`}))}fs.writeJson(`${tempDir}/${tempString}/Contents.json`,a,{spaces:"\t"},function(e){if(e)return console.error(e);saveIconsetToPath(`${tempDir}/${tempString}`)})})}),ipcMain.on("deleted",(e,t)=>{touchBar1=new TouchBar(buttons),win.setTouchBar(touchBar1)}),app.on("open-prefs",e=>{let t;switch(store.get("interpolation")){case"cubic":t=1;break;case"mitchell":t=2;break;case"lanczos2":t=3;break;case"lanczos3":t=4;break;default:t=0}groupPrefs=new TouchBarSegmentedControl({segmentStyle:"separated",mode:"single",segments:[{label:i18n.t("prefs:touchbar.interpolation.nearest","Nearest Neighbour")},{label:i18n.t("prefs:touchbar.interpolation.cubic","Cubic")},{label:i18n.t("prefs:touchbar.interpolation.mitchell","Mitchell")},{label:i18n.t("prefs:touchbar.interpolation.lanczos2","Lanczos a=2")},{label:i18n.t("prefs:touchbar.interpolation.lanczos3","Lanczos a=3")}],selectedIndex:t,change:e=>{modal.webContents.send("prefs-select",e)}}),prefsButtons.push(groupPrefs),prefsButtons.push(new TouchBarButton({label:i18n.t("prefs:button.close","Close"),backgroundColor:"#3B88FD",click:()=>{modal.close()}})),prefsTouchBar=new TouchBar(prefsButtons),(modal=new BrowserWindow({parent:win,modal:!0,width:360,minWidth:360,maxWidth:360,height:210,minHeight:210,resizable:!1,show:!1,transparent:!0,webPreferences:{preload:path.join(__dirname,"./preload.min.js")}})).loadURL(url.format({pathname:path.join(__dirname,"/../html/prefs.html"),protocol:"file:",slashes:!0})),modal.setTouchBar(prefsTouchBar),modal.once("ready-to-show",()=>{modal.show()})}),ipcMain.on("prefs-change",(e,t)=>{groupPrefs.selectedIndex=parseInt(t)});
//# sourceMappingURL=maps/main.min.js.map
